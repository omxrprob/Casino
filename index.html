<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Money Casino Slot</title>
  
  <link rel="manifest" href="manifest.json">
  
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #222;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h1 { margin-top: 20px; }

    #slot-machine {
      font-size: 3em;
      margin: 20px;
    }

    .slot {
      display: inline-block;
      width: 80px;
      height: 80px;
      line-height: 80px;
      margin: 0 10px;
      background: #444;
      border-radius: 10px;
    }

    input, button, select {
      font-size: 1em;
      padding: 10px;
      margin: 10px 5px;
      border: none;
      border-radius: 5px;
    }

    input {
      width: 100px;
      text-align: center;
    }

    #balance {
      margin-top: 20px;
      font-size: 1.5em;
    }

    #shop {
      margin-top: 40px;
      border-top: 2px solid #888;
      padding-top: 20px;
    }

    /* Mute/Unmute button */
    #audioToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      background: #555;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px;
      cursor: pointer;
    }
    
    /* Gift code buttons */
    .top-buttons {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
    }
    
    .top-buttons button {
      background: #555;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px;
      cursor: pointer;
      margin-right: 5px;
    }

    /* Popup container */
    .popup-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .popup-content {
      background: #333;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    
    .popup-content h2 {
      margin-top: 0;
    }

    .popup-content input {
      width: 250px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

  <script src="https://www.youtube.com/iframe_api"></script>

</head>
<body>

<div id="yt-audio" style="width:1;height:1;overflow:hidden;">
  <div id="yt-player"></div>
</div>

<button id="audioToggle" onclick="toggleAudio()">üîá Unmute</button>

<div class="top-buttons">
  <button id="buyGiftCodeBtn" onclick="showBuyGiftCodePopup()">üéÅ Buy Gift Code</button>
  <button id="giftCodeBtn" onclick="showGiftCodePopup()">üéÅ Redeem Gift Code</button>
</div>

<div id="giftCodePopup" class="popup-container" style="display: none;">
  <div class="popup-content">
    <h2>üéÅ Enter Gift Code</h2>
    <input type="text" id="giftCodeInput" placeholder="Enter code here">
    <br>
    <button onclick="redeemGiftCode()">Redeem</button>
    <button onclick="hideGiftCodePopup()">Close</button>
    <p id="giftCodeMessage"></p>
  </div>
</div>

<div id="buyGiftCodePopup" class="popup-container" style="display: none;">
  <div class="popup-content">
    <h2>üí∏ Buy a Gift Code</h2>
    <p id="buyGiftCodePrice">Price: $50</p>
    <button onclick="buyGiftCode()">Buy</button>
    <button onclick="hideBuyGiftCodePopup()">Close</button>
    <p id="buyGiftCodeMessage"></p>
  </div>
</div>

<div id="start-screen" style="text-align:center; margin-top:100px;">
  <h2>üéÆ Welcome to the Casino</h2>
  <button onclick="startNewGame()">Start New Game</button>
  <button onclick="toggleLoadInput()">Play Previous Game</button>

  <div id="load-screen" style="display:none; margin-top: 20px;">
    <input type="text" id="loadCodeInput" placeholder="Paste save code (optional)">
    <button onclick="loadPreviousGame()">Load Game</button>
  </div>
</div>

<div id="game-content" style="display:none;">
  <h1>üé∞ Casino Slot Machine</h1>

  <div>
    <label for="betAmount">Bet Amount:</label>
    <input type="text" id="betAmount" value="10">
    <button onclick="spin()">Spin</button>
    <button id="autoSpinBtn" onclick="toggleAutoSpin()">Auto Spin: OFF</button>
  </div>
  <div>
    <label for="autoSpinDelay">Auto Spin Delay (seconds):</label>
    <input type="number" id="autoSpinDelay" value="2.5" min="0.1" step="0.1">
  </div>


  <div id="slot-machine">
    <div class="slot" id="slot1">‚ùì</div>
    <div class="slot" id="slot2">‚ùì</div>
    <div class="slot" id="slot3">‚ùì</div>
  </div>

  <div id="balance">Balance: $100</div>
  <div id="message"></div>

  <div id="shop">
    <h2>üõí Market</h2>
    <div>
      <select id="shopItem"></select>
      <button onclick="buyItem()">Buy</button>
      <button onclick="sellItem()">Sell</button>
    </div>
    <div id="inventory">Inventory: (empty)</div>
  </div>

  <div>
    <h3>üíæ Save Code:</h3>
    <div id="saveCodeDisplay" style="font-size: 0.8em; color: #aaa; word-break: break-all; display: inline-block;"></div>
    <button id="copySaveCodeBtn" onclick="copySaveCode()">Copy</button>
  </div>
</div>

<script>
  let balance = 100;
  let inventory = {};
  let usedGiftCodes = new Set();
  const symbols = ['üçí', 'üçã', 'üîî', 'üíé', '7Ô∏è‚É£'];
  let isMuted = true;
  // ‚ö†Ô∏è IMPORTANT: Change this to a long, random, and secure string.
  const SECRET_SAVE_KEY = 'YOUR_SECRET_SAVE_KEY_HERE';

  let boughtGiftCodes = new Map();
  const blockedWords = new Set([
    "fuck", "shit", "ass", "bitch", "cunt",
    "money", "gift", "code", "jackpot",
    "win", "free"
  ]);

  const shopItems = {
    "Lucky Charm": { base: 50, price: 50 },
    "Super Clover": { base: 100, price: 100 },
    "Jackpot Gem": { base: 200, price: 200 }
  };

  let player;
  let autoSpinInterval = null;

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('yt-player', {
      height: '0',
      width: '0',
      videoId: '2J4jD60K01M',
      playerVars: {
        'autoplay': 1,
        'loop': 1,
        'controls': 0,
        'disablekb': 1,
        'modestbranding': 1,
        'mute': 1,
        'playlist': '2J4jD60K01M'
      },
      events: {
        'onReady': onPlayerReady
      }
    });
  }

  function onPlayerReady(event) {}

  function toggleAudio() {
    const button = document.getElementById("audioToggle");
    if (isMuted) {
      player.unMute();
      player.playVideo();
      button.innerText = "üîä Mute";
    } else {
      player.mute();
      button.innerText = "üîá Unmute";
    }
    isMuted = !isMuted;
  }

  function startNewGame() {
    balance = 100;
    inventory = {};
    usedGiftCodes = new Set();
    boughtGiftCodes = new Map();
    showGameScreen();
  }

  function toggleLoadInput() {
    document.getElementById('load-screen').style.display = 'block';
  }

  function loadPreviousGame() {
    const codeInput = document.getElementById("loadCodeInput").value.trim();
    try {
      const codeToLoad = codeInput || localStorage.getItem("casinoSave");
      if (!codeToLoad) throw new Error("No save data found");
      const [encodedData, signature] = codeToLoad.split(':');
      if (!encodedData || !signature) throw new Error("Invalid save format");
      const decodedData = atob(encodedData);
      const expectedSignature = sha256.hmac(SECRET_SAVE_KEY, decodedData);
      if (signature !== expectedSignature) {
        throw new Error("Invalid or corrupted save code!");
      }
      const data = JSON.parse(decodedData);
      if (!("balance" in data) || !("inventory" in data) || !("usedGiftCodes" in data) || !("boughtGiftCodes" in data)) {
        throw new Error("Invalid save data structure");
      }
      balance = data.balance;
      inventory = data.inventory;
      usedGiftCodes = new Set(data.usedGiftCodes);
      boughtGiftCodes = new Map(data.boughtGiftCodes);
      showGameScreen();
    } catch (e) {
      alert(`‚ùå Error loading game: ${e.message}\nMake sure your SECRET_SAVE_KEY is correct.`);
    }
  }

  function showGameScreen() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-content').style.display = 'block';
    updateBalance();
    updateInventory();
    updateMarketPrices();
    schedulePriceUpdate();
    saveGame();
  }

  function updateBalance() {
    document.getElementById('balance').innerText = `Balance: $${balance.toFixed(2)}`;
  }

  function updateInventory() {
    const entries = Object.entries(inventory);
    const invText = entries.length
      ? entries.map(([item, count]) => `${item} x${count}`).join(', ')
      : "(empty)";
    document.getElementById('inventory').innerText = "Inventory: " + invText;
  }

  function updateMarketPrices() {
    for (let item in shopItems) {
      const multiplier = 1 + Math.random() * 0.9;
      shopItems[item].price = Math.max(50, Math.min(500, Math.round(shopItems[item].base * multiplier)));
    }
    updateShopDropdown();
  }

  function updateShopDropdown() {
    const select = document.getElementById('shopItem');
    select.innerHTML = '';
    for (let item in shopItems) {
      const price = shopItems[item].price;
      const emoji = item === "Lucky Charm" ? "üéÅ" : item === "Super Clover" ? "üçÄ" : "üíé";
      const option = document.createElement('option');
      option.value = item;
      option.textContent = `${emoji} ${item} - $${price}`;
      select.appendChild(option);
    }
  }

  function buyItem() {
    const itemName = document.getElementById('shopItem').value;
    const itemPrice = shopItems[itemName].price;
    if (balance <= 0 || balance < itemPrice) {
      alert("You don't have enough money to buy this item.");
      return;
    }
    balance -= itemPrice;
    inventory[itemName] = (inventory[itemName] || 0) + 1;
    updateBalance();
    updateInventory();
    saveGame();
  }

  function sellItem() {
    const items = Object.keys(inventory);
    if (!items.length) {
      alert("You have nothing to sell!");
      return;
    }
    const itemName = items[0];
    const price = shopItems[itemName].price;
    if (inventory[itemName] <= 0) {
      alert("You don't have this item to sell!");
      return;
    }
    inventory[itemName]--;
    if (inventory[itemName] <= 0) delete inventory[itemName];
    balance += price;
    alert(`You sold your ${itemName} for $${price}`);
    updateBalance();
    updateInventory();
    saveGame();
  }

  function spin() {
    const betInput = document.getElementById('betAmount').value.trim();
    let bet;
    const msg = document.getElementById('message');

    if (betInput.endsWith('%')) {
      const percent = parseFloat(betInput.slice(0, -1));
      if (isNaN(percent) || percent <= 0) {
        msg.innerText = 'Enter a valid percentage (e.g., 10%).';
        return;
      }
      bet = balance * (percent / 100);
    } else {
      bet = parseFloat(betInput);
      if (isNaN(bet) || bet <= 0) {
        msg.innerText = 'Enter a valid bet amount.';
        return;
      }
    }

    if (balance < bet) {
      msg.innerText = 'Not enough balance!';
      // If auto-spin is on, stop it to prevent infinite errors
      if (autoSpinInterval) {
        toggleAutoSpin();
      }
      return;
    }

    balance -= bet;

    const boostChance = getBoostMultiplier();
    const roll = () => symbols[Math.floor(Math.random() * symbols.length)];
    let slot1 = roll();
    let slot2 = roll();
    let slot3 = roll();

    if (Math.random() < boostChance) {
      const luckySymbol = symbols[Math.floor(Math.random() * symbols.length)];
      slot1 = slot2 = slot3 = luckySymbol;
    }

    document.getElementById('slot1').innerText = slot1;
    document.getElementById('slot2').innerText = slot2;
    document.getElementById('slot3').innerText = slot3;

    let winnings = 0;
    if (slot1 === '7Ô∏è‚É£' && slot2 === '7Ô∏è‚É£' && slot3 === '7Ô∏è‚É£') {
      winnings = bet * 5;
      msg.innerText = `üî• Triple 7s! You won $${winnings.toFixed(2)}!`;
    } else if (slot1 === slot2 && slot2 === slot3) {
      winnings = bet * 3.5;
      msg.innerText = `üéâ Jackpot! You won $${winnings.toFixed(2)}!`;
    } else if (slot1 === slot2 || slot2 === slot3 || slot1 === '7Ô∏è‚É£') {
      winnings = bet * 2;
      msg.innerText = `üòä Nice! You won $${winnings.toFixed(2)}!`;
    } else {
      msg.innerText = 'üôÅ Try again!';
    }

    balance += winnings;
    updateBalance();
    saveGame();
  }

  function toggleAutoSpin() {
    const autoSpinBtn = document.getElementById('autoSpinBtn');
    const delayInput = document.getElementById('autoSpinDelay');
    let delay = parseFloat(delayInput.value) * 1000;

    if (isNaN(delay) || delay < 100) {
      alert("Please enter a valid delay (minimum 0.1 seconds).");
      return;
    }

    if (autoSpinInterval) {
      clearInterval(autoSpinInterval);
      autoSpinInterval = null;
      autoSpinBtn.innerText = 'Auto Spin: OFF';
      autoSpinBtn.style.background = '';
    } else {
      autoSpinInterval = setInterval(spin, delay);
      autoSpinBtn.innerText = 'Auto Spin: ON';
      autoSpinBtn.style.background = '#6c3';
    }
  }

  function getBoostMultiplier() {
    let multiplier = 0;
    for (let item in inventory) {
      const count = inventory[item];
      if (item === "Lucky Charm") multiplier += 0.03 * count;
      if (item === "Super Clover") multiplier += 0.05 * count;
      if (item === "Jackpot Gem") multiplier += 0.08 * count;
    }
    return Math.min(multiplier, 0.7);
  }

  function saveGame() {
    const state = {
      balance: balance,
      inventory: inventory,
      boughtGiftCodes: Array.from(boughtGiftCodes.entries()),
      usedGiftCodes: Array.from(usedGiftCodes)
    };
    const stateString = JSON.stringify(state);
    const signature = sha256.hmac(SECRET_SAVE_KEY, stateString);
    const code = btoa(stateString) + ':' + signature;
    document.getElementById('saveCodeDisplay').innerText = code;
    localStorage.setItem("casinoSave", code);
  }

  function copySaveCode() {
    const saveCode = document.getElementById('saveCodeDisplay').innerText;
    if (saveCode) {
        navigator.clipboard.writeText(saveCode)
            .then(() => {
                alert('üíæ Save code copied to clipboard!');
            })
            .catch(err => {
                console.error('Failed to copy text: ', err);
                alert('‚ùå Failed to copy the save code. Please copy it manually.');
            });
    }
  }

  function schedulePriceUpdate() {
    updateMarketPrices();
    setTimeout(schedulePriceUpdate, 5000 + Math.random() * 5000);
  }

  function showGiftCodePopup() {
    document.getElementById('giftCodePopup').style.display = 'flex';
  }

  function hideGiftCodePopup() {
    document.getElementById('giftCodePopup').style.display = 'none';
    document.getElementById('giftCodeInput').value = '';
    document.getElementById('giftCodeMessage').innerText = '';
  }

  function showBuyGiftCodePopup() {
    const priceTextElement = document.getElementById('buyGiftCodePrice');
    if (balance <= 0) {
      document.getElementById('buyGiftCodeMessage').innerText = `‚ùå You don't have any money to buy a gift code!`;
      document.getElementById('buyGiftCodePopup').style.display = 'flex';
      return;
    }
    const randomPercentage = Math.floor(Math.random() * (90 - 25 + 1)) + 25;
    const price = balance * (randomPercentage / 100);
    priceTextElement.dataset.price = price;
    priceTextElement.innerText = `Price: $${price.toFixed(2)} (${randomPercentage}%)`;
    document.getElementById('buyGiftCodePopup').style.display = 'flex';
  }
  
  function hideBuyGiftCodePopup() {
    document.getElementById('buyGiftCodePopup').style.display = 'none';
    document.getElementById('buyGiftCodeMessage').innerText = '';
  }

  function buyGiftCode() {
    const priceTextElement = document.getElementById('buyGiftCodePrice');
    const price = parseFloat(priceTextElement.dataset.price);
    if (balance <= 0 || balance < price) {
      document.getElementById('buyGiftCodeMessage').innerText = `‚ùå Not enough money! You need $${price.toFixed(2)}.`;
      return;
    }
    balance -= price;
    updateBalance();
    const newCode = Math.random().toString(36).substring(2, 10).toUpperCase();
    const successChance = Math.floor(Math.random() * 70) + 10;
    boughtGiftCodes.set(newCode, successChance);
    document.getElementById('buyGiftCodeMessage').innerText = `üéâ You bought a gift code for $${price.toFixed(2)}!
    It has a ${successChance}% chance of working.
    Code: ${newCode}`;
    saveGame();
  }

  function redeemGiftCode() {
    const code = document.getElementById('giftCodeInput').value.trim().toLowerCase();
    const messageElement = document.getElementById('giftCodeMessage');
    if (blockedWords.has(code)) {
      messageElement.innerText = "‚ùå That code is invalid.";
      return;
    }
    if (usedGiftCodes.has(code)) {
      messageElement.innerText = "‚ùå You have already redeemed this code!";
      return;
    }
    const dailyCode = "dailygift";
    if (code === dailyCode) {
      balance += 1000;
      usedGiftCodes.add(code);
      updateBalance();
      saveGame();
      messageElement.innerText = `üéâ Success! You received $1000!`;
      return;
    }
    const upperCaseCode = code.toUpperCase();
    if (boughtGiftCodes.has(upperCaseCode)) {
      const successChance = boughtGiftCodes.get(upperCaseCode);
      const randomRoll = Math.floor(Math.random() * 100) + 1;
      boughtGiftCodes.delete(upperCaseCode);
      usedGiftCodes.add(upperCaseCode);
      saveGame();
      if (randomRoll <= successChance) {
        let rewardText = "";
        const rewardType = getRandomReward();
        if (rewardType.startsWith('money_')) {
          const amount = parseInt(rewardType.split('_')[1]);
          balance += amount;
          rewardText = `You received $${amount}!`;
        } else if (rewardType.startsWith('item_')) {
          const item = rewardType.split('_')[1];
          inventory[item] = (inventory[item] || 0) + 1;
          rewardText = `You received a ${item}!`;
        } else if (rewardType === 'gift_code') {
          const newGiftCode = Math.random().toString(36).substring(2, 10).toUpperCase();
          const newSuccessChance = Math.floor(Math.random() * 70) + 10;
          boughtGiftCodes.set(newGiftCode, newSuccessChance);
          rewardText = `You received a new gift code with a ${newSuccessChance}% chance! Code: ${newGiftCode}`;
        }
        updateBalance();
        updateInventory();
        messageElement.innerText = `üéâ Success! The code worked! ${rewardText}`;
        return;
      } else {
        messageElement.innerText = `üôÅ Unlucky! The code had a ${successChance}% chance but it failed. Better luck next time!`;
        return;
      }
    }
    messageElement.innerText = "‚ùå Invalid or expired gift code.";
  }

  function getRandomReward() {
    const roll = Math.random();
    if (roll < 0.05) {
      return 'gift_code';
    } else if (roll < 0.40) {
      const items = ['Lucky Charm', 'Super Clover', 'Jackpot Gem'];
      const item = items[Math.floor(Math.random() * items.length)];
      return `item_${item}`;
    } else {
      const amounts = [50, 100, 200, 500, 1000];
      const amount = amounts[Math.floor(Math.random() * amounts.length)];
      return `money_${amount}`;
    }
  }
</script>

</body>
</html>
